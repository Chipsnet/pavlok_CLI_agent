# Oni System v0.3 Slack UI仕様書

## 1. UI設計方針

### 1.1 基本原則

1. **モーダル活用**: 入力が必要な操作はモーダルで一元管理（`plain_text_input`はモーダル内でのみ使用可能）
2. **エフェメラル優先**: 個人向けの実行結果やエラー通知はエフェメラルメッセージで表示
3. **パブリックは通知のみ**: remind/ignore通知など、チーム全体に共有すべき情報のみパブリックメッセージ
4. **即時フィードバック**: ボタン操作に対して即座に応答

### 1.2 BlockKit制約への対処

BlockKitの `plain_text_input` はモーダル内でのみ使用可能。以下の戦略で対処：

| 入力タイプ | 解決策 |
|-----------|--------|
| 選択肢（列挙型） | `static_select` をモーダル内で使用 |
| 数値（範囲指定） | `plain_text_input` で入力 + バリデーション |
| ON/OFF | `checkboxes` をモーダル内で使用 |
| フリーテキスト | `plain_text_input` をモーダル内で使用 |

**参考**: [Slack公式ドキュメント - Modals](https://docs.slack.dev/surfaces/modals/)

---

## 2. スラッシュコマンドUI

### 2.1 `/base_commit` - コミットメント管理

#### 2.1.1 コミットメント入力モーダル

`/base_commit` コマンド実行時にモーダルを開き、コミットメント一覧を表示・編集する。

**データソース**: commitmentsテーブルを照会し、既存レコードをデフォルト値として設定。
**最小表示数**: commitmentsレコードが3未満の場合でも、UI上は3つの入力行を表示。

**参考**: [Slack公式ドキュメント - Time Picker](https://docs.slack.dev/reference/block-kit/block-elements/time-picker-element)

```json
{
  "type": "modal",
  "callback_id": "base_commit_submit",
  "title": {
    "type": "plain_text",
    "text": "📋 コミットメント管理"
  },
  "submit": {
    "type": "plain_text",
    "text": "送信"
  },
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "毎日実行するコミットメントを設定します。入力内容はplan_APIに送信されます。"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "input",
      "block_id": "commitment_1",
      "label": {
        "type": "plain_text",
        "text": "コミットメント 1"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "task_1",
        "initial_value": "朝の瞑想",
        "placeholder": {
          "type": "plain_text",
          "text": "タスク名"
        },
        "max_length": 100
      },
      "dispatch_action": true
    },
    {
      "type": "input",
      "block_id": "time_1",
      "label": {
        "type": "plain_text",
        "text": "時刻 1"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time_1",
        "initial_time": "07:00",
        "placeholder": {
          "type": "plain_text",
          "text": "時間を選択"
        }
      },
      "optional": true
    },
    {
      "type": "divider"
    },
    {
      "type": "input",
      "block_id": "commitment_2",
      "label": {
        "type": "plain_text",
        "text": "コミットメント 2"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "task_2",
        "initial_value": "メールチェック",
        "placeholder": {
          "type": "plain_text",
          "text": "タスク名"
        },
        "max_length": 100
      },
      "optional": true
    },
    {
      "type": "input",
      "block_id": "time_2",
      "label": {
        "type": "plain_text",
        "text": "時刻 2"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time_2",
        "initial_time": "09:00",
        "placeholder": {
          "type": "plain_text",
          "text": "時間を選択"
        }
      },
      "optional": true
    },
    {
      "type": "divider"
    },
    {
      "type": "input",
      "block_id": "commitment_3",
      "label": {
        "type": "plain_text",
        "text": "コミットメント 3"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "task_3",
        "initial_value": "振り返り",
        "placeholder": {
          "type": "plain_text",
          "text": "タスク名"
        },
        "max_length": 100
      },
      "optional": true
    },
    {
      "type": "input",
      "block_id": "time_3",
      "label": {
        "type": "plain_text",
        "text": "時刻 3"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time_3",
        "initial_time": "22:00",
        "placeholder": {
          "type": "plain_text",
          "text": "時間を選択"
        }
      },
      "optional": true
    },
    {
      "type": "divider"
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "+ 追加"
          },
          "style": "primary",
          "action_id": "commitment_add_row"
        }
      ]
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "💡 コミットメントは毎日指定時刻にplanイベントとして登録されます"
        }
      ]
    }
  ]
}
```

**アクション定義**:

| アクション | 説明 |
|-----------|------|
| 送信ボタン | 入力された全コミットメント情報を含めてplan_APIをコール |
| + 追加ボタン | `views.update`で新しい入力行を追加（最大10行まで） |
| ×ボタン（右上） | モーダルを閉じる |

**実装上の注意**:
- commitmentsテーブルのidは `private_metadata` にJSONで保持し、hidden的扱いとする
- 既存レコード数に関わらず、最低3行の入力欄を表示
- 空の行は送信時に除外する

---

### 2.2 `/stop` - 罰停止

コマンド実行時に確認なしで即座に停止し、完了メッセージを返す（`/restart`と同様のUX）。

#### 2.2.1 停止完了通知（エフェメラル）

```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "⏸️ *鬼コーチを停止しました*\n\n再開するには `/restart` を実行してください。"
      }
    }
  ]
}
```

---

### 2.3 `/restart` - 罰再開

#### 2.3.1 再開確認（エフェメラル）

```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "▶️ *鬼コーチを再開しました*"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "次回のWorkerサイクルから通常運用が再開されます"
        }
      ]
    }
  ]
}
```

---

### 2.4 `/config` - 設定管理

`/config` コマンド実行時にモーダルを開き、全設定を一元管理する。

**データソース**: DBに設定値がある場合はその値をデフォルト、なければ環境変数値をデフォルトとする。

#### 2.4.1 設定管理モーダル

```json
{
  "type": "modal",
  "callback_id": "config_submit",
  "title": {
    "type": "plain_text",
    "text": "⚙️ Oni System 設定"
  },
  "submit": {
    "type": "plain_text",
    "text": "保存"
  },
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "🔴 罰設定"
      }
    },
    {
      "type": "input",
      "block_id": "PAVLOK_TYPE_PUNISH",
      "label": {
        "type": "plain_text",
        "text": "デフォルト罰スタイル"
      },
      "element": {
        "type": "static_select",
        "action_id": "PAVLOK_TYPE_PUNISH_select",
        "initial_option": {
          "text": {"type": "plain_text", "text": "⚡ zap (電気ショック)"},
          "value": "zap"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "⚡ zap (電気ショック)"}, "value": "zap"},
          {"text": {"type": "plain_text", "text": "📳 vibe (振動)"}, "value": "vibe"},
          {"text": {"type": "plain_text", "text": "🔊 beep (音)"}, "value": "beep"}
        ]
      }
    },
    {
      "type": "input",
      "block_id": "PAVLOK_VALUE_PUNISH",
      "label": {
        "type": "plain_text",
        "text": "デフォルト罰強度 (0-100)"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "PAVLOK_VALUE_PUNISH_input",
        "initial_value": "50",
        "placeholder": {
          "type": "plain_text",
          "text": "0-100の数値"
        },
        "min_length": 1,
        "max_length": 3
      },
      "hint": {
        "type": "plain_text",
        "text": ":warning: 80以上は非常に強力です。十分に注意してください。"
      }
    },
    {
      "type": "input",
      "block_id": "LIMIT_DAY_PAVLOK_COUNTS",
      "label": {
        "type": "plain_text",
        "text": "1日の最大ZAP回数"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "LIMIT_DAY_PAVLOK_COUNTS_input",
        "initial_value": "100",
        "placeholder": {
          "type": "plain_text",
          "text": "例: 100"
        },
        "min_length": 1,
        "max_length": 4
      }
    },
    {
      "type": "input",
      "block_id": "LIMIT_PAVLOK_ZAP_VALUE",
      "label": {
        "type": "plain_text",
        "text": "最大ZAP強度 (安全リミット)"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "LIMIT_PAVLOK_ZAP_VALUE_input",
        "initial_value": "100",
        "placeholder": {
          "type": "plain_text",
          "text": "0-100の数値"
        },
        "min_length": 1,
        "max_length": 3
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "⚡ Ignoreモード設定"
      }
    },
    {
      "type": "input",
      "block_id": "IGNORE_INTERVAL",
      "label": {
        "type": "plain_text",
        "text": "検知間隔 (秒)"
      },
      "element": {
        "type": "static_select",
        "action_id": "IGNORE_INTERVAL_select",
        "initial_option": {
          "text": {"type": "plain_text", "text": "15分 (900秒)"},
          "value": "900"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "5分 (300秒)"}, "value": "300"},
          {"text": {"type": "plain_text", "text": "10分 (600秒)"}, "value": "600"},
          {"text": {"type": "plain_text", "text": "15分 (900秒)"}, "value": "900"},
          {"text": {"type": "plain_text", "text": "30分 (1800秒)"}, "value": "1800"}
        ]
      }
    },
    {
      "type": "input",
      "block_id": "IGNORE_JUDGE_TIME",
      "label": {
        "type": "plain_text",
        "text": "判定時間 (秒)"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "IGNORE_JUDGE_TIME_input",
        "initial_value": "3",
        "placeholder": {
          "type": "plain_text",
          "text": "例: 3"
        },
        "min_length": 1,
        "max_length": 3
      }
    },
    {
      "type": "input",
      "block_id": "IGNORE_MAX_RETRY",
      "label": {
        "type": "plain_text",
        "text": "最大再試行回数"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "IGNORE_MAX_RETRY_input",
        "initial_value": "5",
        "placeholder": {
          "type": "plain_text",
          "text": "例: 5"
        },
        "min_length": 1,
        "max_length": 2
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "⏱️ タイムアウト設定"
      }
    },
    {
      "type": "input",
      "block_id": "TIMEOUT_REMIND",
      "label": {
        "type": "plain_text",
        "text": "リマインドタイムアウト (秒)"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "TIMEOUT_REMIND_input",
        "initial_value": "600",
        "placeholder": {
          "type": "plain_text",
          "text": "例: 600"
        },
        "min_length": 1,
        "max_length": 5
      }
    },
    {
      "type": "input",
      "block_id": "TIMEOUT_REVIEW",
      "label": {
        "type": "plain_text",
        "text": "振り返りタイムアウト (秒)"
      },
      "element": {
        "type": "plain_text_input",
        "action_id": "TIMEOUT_REVIEW_input",
        "initial_value": "600",
        "placeholder": {
          "type": "plain_text",
          "text": "例: 600"
        },
        "min_length": 1,
        "max_length": 5
      }
    },
    {
      "type": "input",
      "block_id": "RETRY_DELAY",
      "label": {
        "type": "plain_text",
        "text": "リトライ遅延 (分)"
      },
      "element": {
        "type": "static_select",
        "action_id": "RETRY_DELAY_select",
        "initial_option": {
          "text": {"type": "plain_text", "text": "5分"},
          "value": "5"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "1分"}, "value": "1"},
          {"text": {"type": "plain_text", "text": "3分"}, "value": "3"},
          {"text": {"type": "plain_text", "text": "5分"}, "value": "5"},
          {"text": {"type": "plain_text", "text": "10分"}, "value": "10"},
          {"text": {"type": "plain_text", "text": "15分"}, "value": "15"}
        ]
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "🔄 全リセット"
          },
          "style": "danger",
          "action_id": "config_reset_all",
          "confirm": {
            "title": {
              "type": "plain_text",
              "text": "確認"
            },
            "text": {
              "type": "plain_text",
              "text": "全ての設定をデフォルト値にリセットします。よろしいですか？"
            },
            "confirm": {
              "type": "plain_text",
              "text": "リセット"
            },
            "deny": {
              "type": "plain_text",
              "text": "キャンセル"
            }
          }
        },
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "📋 変更履歴"
          },
          "action_id": "config_history"
        }
      ]
    }
  ]
}
```

**実装上の注意**:
- `block_id` に設定キー名を設定し、送信時のパースを簡略化
- 数値入力はバリデーションを実施（0-100範囲など）
- 保存時は audit_logs テーブルに変更履歴を記録

---

### 2.5 `/audit` - 監査ログ表示

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "📋 設定変更履歴 (直近7日間)"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*2026-02-13 20:30*\n`PAVLOK_VALUE_PUNISH`: 50 → 70\nby @user"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*2026-02-12 15:00*\n`IGNORE_INTERVAL`: 900 → 600\nby @user"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*2026-02-10 09:00*\n`LIMIT_DAY_PAVLOK_COUNTS`: 100 → 50\nby @user"
      }
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "もっと見る"
          },
          "action_id": "audit_more"
        }
      ]
    }
  ]
}
```

---

## 3. Workerイベント通知UI

### 3.1 planイベント - 開始通知＋モーダル

Workerが朝（設定時刻）にSlackへ通知を投稿し、ユーザーがボタンをクリックしてモーダルを開く。

#### 3.1.0 plan開始通知（パブリック）

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "📅 今日の予定を登録しましょう"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "おはようございます！今日の計画を立てましょう。\n以下のボタンをクリックして予定を登録してください。"
      }
    },
    {
      "type": "actions",
      "block_id": "plan_trigger",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "📝 予定を登録"
          },
          "style": "primary",
          "action_id": "plan_open_modal",
          "value": "{\"schedule_id\": 123}"
        }
      ]
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "⏰ 応答がない場合、15分後に催促が始まります"
        }
      ]
    }
  ]
}
```

**アクション定義**:

| アクション | 説明 |
|-----------|------|
| 「📝 予定を登録」ボタン | モーダルを開く（trigger_idを使用） |

---

#### 3.1.1 予定入力モーダル

> **UX設計原則**:
> - タスク名は固定（commitmentsから取得）、変更不可
> - dateは現在時刻を基準に「今日」「明日」を選択可能
> - hour/minはcommitments設定値をデフォルトとし、変更可能
> - スキップするタスクはチェックボックスで選択

#### 3.1.1 予定入力モーダル

> **設計方針**:
> - モーダル形式で一括送信
> - 各タスク: section（タスク名）+ input（実行日）+ input（実行時間）+ input（やらない）
> - 「次回計画」は必須（スキップ不可）
> - block_idでイベント種別を識別

**参考**: [Slack公式ドキュメント - Time Picker](https://docs.slack.dev/reference/block-kit/block-elements/time-picker-element)

```json
{
  "type": "modal",
  "callback_id": "plan_submit",
  "title": {
    "type": "plain_text",
    "text": "📅 今日の予定"
  },
  "submit": {
    "type": "plain_text",
    "text": "送信"
  },
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*🧘 朝の瞑想*"
      }
    },
    {
      "type": "input",
      "block_id": "task_1_date",
      "label": {
        "type": "plain_text",
        "text": "実行日"
      },
      "element": {
        "type": "static_select",
        "action_id": "date",
        "initial_option": {
          "text": {"type": "plain_text", "text": "今日"},
          "value": "today"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "今日"}, "value": "today"},
          {"text": {"type": "plain_text", "text": "明日"}, "value": "tomorrow"}
        ]
      }
    },
    {
      "type": "input",
      "block_id": "task_1_time",
      "label": {
        "type": "plain_text",
        "text": "実行時間"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time",
        "initial_time": "07:00"
      }
    },
    {
      "type": "input",
      "block_id": "task_1_skip",
      "label": {
        "type": "plain_text",
        "text": "やらない"
      },
      "element": {
        "type": "checkboxes",
        "action_id": "skip",
        "options": [
          {
            "text": {"type": "plain_text", "text": "今日は実行しない"},
            "value": "skip"
          }
        ]
      },
      "optional": true
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*📧 メールチェック*"
      }
    },
    {
      "type": "input",
      "block_id": "task_2_date",
      "label": {
        "type": "plain_text",
        "text": "実行日"
      },
      "element": {
        "type": "static_select",
        "action_id": "date",
        "initial_option": {
          "text": {"type": "plain_text", "text": "今日"},
          "value": "today"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "今日"}, "value": "today"},
          {"text": {"type": "plain_text", "text": "明日"}, "value": "tomorrow"}
        ]
      }
    },
    {
      "type": "input",
      "block_id": "task_2_time",
      "label": {
        "type": "plain_text",
        "text": "実行時間"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time",
        "initial_time": "09:00"
      }
    },
    {
      "type": "input",
      "block_id": "task_2_skip",
      "label": {
        "type": "plain_text",
        "text": "やらない"
      },
      "element": {
        "type": "checkboxes",
        "action_id": "skip",
        "options": [
          {
            "text": {"type": "plain_text", "text": "今日は実行しない"},
            "value": "skip"
          }
        ]
      },
      "optional": true
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*📝 振り返り*"
      }
    },
    {
      "type": "input",
      "block_id": "task_3_date",
      "label": {
        "type": "plain_text",
        "text": "実行日"
      },
      "element": {
        "type": "static_select",
        "action_id": "date",
        "initial_option": {
          "text": {"type": "plain_text", "text": "今日"},
          "value": "today"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "今日"}, "value": "today"},
          {"text": {"type": "plain_text", "text": "明日"}, "value": "tomorrow"}
        ]
      }
    },
    {
      "type": "input",
      "block_id": "task_3_time",
      "label": {
        "type": "plain_text",
        "text": "実行時間"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time",
        "initial_time": "22:00"
      }
    },
    {
      "type": "input",
      "block_id": "task_3_skip",
      "label": {
        "type": "plain_text",
        "text": "やらない"
      },
      "element": {
        "type": "checkboxes",
        "action_id": "skip",
        "options": [
          {
            "text": {"type": "plain_text", "text": "今日は実行しない"},
            "value": "skip"
          }
        ]
      },
      "optional": true
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*🔁 次回計画 (event.plan)*"
      }
    },
    {
      "type": "input",
      "block_id": "next_plan_date",
      "label": {
        "type": "plain_text",
        "text": "実行日"
      },
      "element": {
        "type": "static_select",
        "action_id": "date",
        "initial_option": {
          "text": {"type": "plain_text", "text": "明日"},
          "value": "tomorrow"
        },
        "options": [
          {"text": {"type": "plain_text", "text": "今日"}, "value": "today"},
          {"text": {"type": "plain_text", "text": "明日"}, "value": "tomorrow"}
        ]
      }
    },
    {
      "type": "input",
      "block_id": "next_plan_time",
      "label": {
        "type": "plain_text",
        "text": "実行時間"
      },
      "element": {
        "type": "timepicker",
        "action_id": "time",
        "initial_time": "07:00"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "💡 次回計画は必須です。スキップできません。"
        }
      ]
    }
  ]
}
```

**アクション定義**:

| アクション | 説明 |
|-----------|------|
| 送信ボタン | 全タスクの情報を一括でschedulesテーブルに登録、remindイベントをスケジュール、次回plan時刻を設定 |
| ×ボタン（右上） | モーダルを閉じる（何もしない、ignore検知で催促） |

**パラメータ設計（イベント識別）**:

| 項目 | タスク入力 | 次回計画 |
|------|-----------|---------|
| block_id | `task_{n}_date`, `task_{n}_time`, `task_{n}_skip` | `next_plan_date`, `next_plan_time` |
| スキップ機能 | あり（checkboxes） | なし（必須） |
| 初期日付 | 今日 | 明日 |

**実装上の注意**:
- `block_id` でタスク番号と入力種別を識別
- 「やらない」チェックが入ったタスクは `is_skip=true` で登録
- `next_plan_date` / `next_plan_time` から次回plan時刻を取得してシステムに設定
- 日付選択の「今日」「明日」は実際の日付に変換して登録

#### 3.1.2 送信完了通知（パブリックメッセージ）

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "📅 本日の予定を登録しました"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*朝の瞑想*\n🕐 今日 07:00\n\n*メールチェック*\n🕐 今日 09:00\n\n*振り返り*\n🕐 今日 22:00"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*🔁 次回計画: 明日 07:00*"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "💡 各時刻にリマインドされます"
        }
      ]
    }
  ]
}
```

---

### 3.2 remindイベント - 激励 + YES/NO

> **UX設計原則**:
> - タスク名を目立たせる（太字）
> - 時間は補助情報
> - アクションボタンを目立つ位置に配置

#### 3.2.1 リマインド投稿

> **設計方針**:
> - action_id/block_idに`remind_`プレフィックスでplanイベントと区別
> - valueにJSON形式で`schedule_id`と`event_type: "remind"`を含める

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "🔔 リマインド"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*朝の瞑想*\n🕐 07:00\n\n静かな場所で5分間、呼吸に集中しましょう。\n準備はできましたか？"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "actions",
      "block_id": "remind_response",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "✓ やりました！"
          },
          "style": "primary",
          "action_id": "remind_yes",
          "value": "{\"schedule_id\": 123, \"event_type\": \"remind\"}"
        },
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "✕ やれません"
          },
          "style": "danger",
          "action_id": "remind_no",
          "value": "{\"schedule_id\": 123, \"event_type\": \"remind\"}"
        }
      ]
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "⚠️ 応答がない場合、15分ごとにPaclokが動作します"
        }
      ]
    }
  ]
}
```

#### 3.2.2 YES応答

```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "🎉 *朝の瞑想*\n✓ 完了しました！\n\n良い一日のスタートです！\n> 静かな心は最高の準備です。"
      }
    }
  ]
}
```

#### 3.2.3 NO応答

```json
{
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "😢 *朝の瞑想*\n✕ できませんでした...\n\n今回のNO回数: 2回\n罰: zap 45%\n\n> 明日こそは、一緒に頑張りましょう。"
      }
    },
    {
      "type": "context",
      "elements": [
        {
          "type": "mrkdwn",
          "text": "⚡ Pavlokから刺激を送信しました"
        }
      ]
    }
  ]
}
```

---

### 3.3 ignore検知通知

#### 3.3.1 無視検知時の通知（パブリック）

> **設計方針**:
> - action_idに`ignore_`プレフィックスでplan/remindと区別
> - valueにJSON形式で`schedule_id`と`event_type: "ignore"`を含める

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "⚠️ 応答待ち"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*朝の瞑想*\n🕐 07:00\n\n応答を待っています...\n\n無視時間: 15分経過\ngentle reminder: vibe 100%"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "✓ 今やりました！"
          },
          "style": "primary",
          "action_id": "ignore_yes",
          "value": "{\"schedule_id\": 123, \"event_type\": \"ignore\"}"
        },
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "✕ やれません"
          },
          "style": "danger",
          "action_id": "ignore_no",
          "value": "{\"schedule_id\": 123, \"event_type\": \"ignore\"}"
        }
      ]
    }
  ]
}
```

#### 3.3.2 最大無視到達時（キャンセル通知）

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "❌ 自動キャンセル"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*朝の瞑想*\n🕐 07:00\n\n長時間無視が続いたため、このタスクは自動的にキャンセルされました。\n\n最終罰: zap 100%\n\n> 次は一緒に頑張りましょう。"
      }
    }
  ]
}
```

---

## 4. エラー・状態通知UI

### 4.1 エラー通知

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "❌ エラーが発生しました"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "設定の保存中にエラーが発生しました。\n\n```\nValueError: 罰強度は0-100の範囲で指定してください\n```"
      }
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "再試行"
          },
          "action_id": "retry_config"
        }
      ]
    }
  ]
}
```

### 4.2 日次最大ZAP到達通知

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "🛑 本日の罰上限に到達"
      }
    },
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "本日のZAP回数が *100回* に達しました。\n\n安全のため、これ以上の罰は実行されません。\n明日はリセットされます。"
      }
    }
  ]
}
```

---

## 5. action_id 設計規約

### 5.1 命名規則

```
{機能}_{アクション}[_{詳細}]
```

### 5.2 action_id 一覧

| action_id | 用途 | value/パラメータ |
|-----------|------|-----------------|
| **base_commit** |||
| `task_{n}` | コミットメント{n}のタスク名入力 | private_metadata: commitment_id |
| `time_{n}` | コミットメント{n}の時刻選択 (timepicker) | HH:mm形式 |
| `commitment_add_row` | コミットメント行追加 | - |
| **plan開始通知** |||
| `plan_open_modal` | モーダルを開くトリガー | `{"schedule_id": n}` |
| **planモーダル** |||
| `date` | タスクの実行日選択 | value: today/tomorrow |
| `time` | タスクの実行時間選択 | HH:mm形式 |
| `skip` | タスクのスキップチェック | value: skip |
| **remindイベント** |||
| `remind_yes` | remind YES | `{"schedule_id": n, "event_type": "remind"}` |
| `remind_no` | remind NO | `{"schedule_id": n, "event_type": "remind"}` |
| **ignore検知** |||
| `ignore_yes` | ignore YES（遅延完了） | `{"schedule_id": n, "event_type": "ignore"}` |
| `ignore_no` | ignore NO | `{"schedule_id": n, "event_type": "ignore"}` |
| **config** |||
| `config_reset_all` | 設定全リセット | - |
| `config_history` | 設定変更履歴表示 | - |
| `audit_more` | 監査ログもっと見る | - |

**識別ルール**:
- planモーダル: `block_id` でタスク番号と入力種別を識別（`task_1_date`, `task_1_time`, `task_1_skip`）
- remind/ignore: `action_id` のプレフィックスでイベント種別を判別、`value`内の`event_type`で二重確認

---

## 6. block_id 設計規約

### 6.1 命名規則

```
{機能}_{要素名}[_{詳細}]
```

### 6.2 主なblock_id

| block_id | 用途 |
|----------|------|
| **base_commit** ||
| `commitment_{n}` | コミットメント{n}のタスク名入力ブロック |
| `time_{n}` | コミットメント{n}の時刻選択ブロック |
| **planモーダル** ||
| `task_{n}_date` | planタスク{n}の実行日選択ブロック |
| `task_{n}_time` | planタスク{n}の実行時間選択ブロック |
| `task_{n}_skip` | planタスク{n}のスキップチェックブロック |
| `next_plan_date` | 次回計画の実行日選択ブロック（必須） |
| `next_plan_time` | 次回計画の実行時間選択ブロック（必須） |
| **remindイベント** ||
| `remind_response` | remind応答ボタン群（actions） |
| **config** ||
| `PAVLOK_TYPE_PUNISH` | 罰スタイル設定 |
| `PAVLOK_VALUE_PUNISH` | 罰強度設定 |
| `LIMIT_DAY_PAVLOK_COUNTS` | 1日最大ZAP回数設定 |
| `LIMIT_PAVLOK_ZAP_VALUE` | 最大ZAP強度設定 |
| `IGNORE_INTERVAL` | Ignore検知間隔設定 |
| `IGNORE_JUDGE_TIME` | Ignore判定時間設定 |
| `IGNORE_MAX_RETRY` | Ignore最大再試行設定 |
| `TIMEOUT_REMIND` | リマインドタイムアウト設定 |
| `TIMEOUT_REVIEW` | 振り返りタイムアウト設定 |
| `RETRY_DELAY` | リトライ遅延設定 |

---

## 7. メッセージタイプ使い分け

| タイプ | 用途 | 例 |
|--------|------|-----|
| **モーダル** | 設定管理、コミットメント入力、plan入力 | `/config`, `/base_commit`, planイベント |
| **パブリック** | remind/ignoreイベント、完了通知 | チャンネル全体に表示（チーム共有） |
| **エフェメラル** | コマンド実行結果、エラー通知 | 本人のみ閲覧可能 |
| **スレッド返信** | YES/NO応答後のコメント | 元メッセージのスレッドに |

**イベント別メッセージタイプ**:

| イベント | タイプ | 理由 |
|---------|--------|------|
| plan | モーダル | 複数入力が必要なフォーム入力 |
| remind | パブリック | 進捗をチームに可視化 |
| ignore | パブリック | 無視状態をチームに警告 |
| base_commit | モーダル | 個人設定のため |
| config | モーダル | 個人設定のため |
