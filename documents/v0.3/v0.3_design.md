## ADR (Architecture Decision Records)

è¨­è¨ˆæ±ºå®šäº‹é …ã¯ä»¥ä¸‹ã®ADRãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ï¼š

- [ADR-001: Gatewayè²¬å‹™å¢ƒç•Œ](./ADR-001-gateway-responsibility.md)
- [ADR-002: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚­ãƒ¼ã¨ãƒãƒƒãƒ”ãƒ³ã‚°æ–¹å¼](./ADR-002-routing-mapping.md)
- [ADR-003: å¸¸æ™‚èµ·å‹•å‰æã®é˜²å¾¡è¨­è¨ˆ](./ADR-003-always-on-security.md)
- [ADR-004: è¨­å®šå€¤ã®æ¡ç”¨ãƒªã‚¹ãƒˆ](./ADR-004-config-values.md)
- [ADR-005: E2Eç¯„å›²ã®å®šç¾©](./ADR-005-e2e-scope.md)

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [å‰Šé™¤æ–¹é‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](./deletion-policy.md)
- [ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ãƒ¡ãƒ¢](./branch-strategy.md)
- [DBç ´å£Šçš„å¤‰æ›´ã‚¿ã‚¤ãƒŸãƒ³ã‚°](./db-migration-timing.md)

---

## TODO ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

| é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å¯¾å¿œ |
|------|-----------|------|
| ç¾çŠ¶ã®å®Ÿè£…ã§ä¸è¦ã«ãªã‚‹ã‚‚ã®ãŒå¤šã„ã®ã§æƒé™¤ãŒå¿…è¦ | âœ… è§£æ±º | [deletion-policy.md](./deletion-policy.md) |
| è¨­å®šå€¤ã‚’å…¨ã¦ä½¿ã£ãŸãƒ­ã‚¸ãƒƒã‚¯ã«å†å®šç¾©ãŒå¿…è¦ | âœ… è§£æ±º | [ADR-004](./ADR-004-config-values.md) |
| `v0.3_slack_ui_spec.md`ã®å®šç¾©ã‚’è¦‹ç›´ã—ãŸã®ã§è¨­è¨ˆæ›¸ã‚‚ä¿®æ­£ãŒå¿…è¦ | âœ… è§£æ±º | æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åæ˜ æ¸ˆã¿ |
| E2Eãƒ†ã‚¹ãƒˆã©ã†ã‚„ã‚‹ã®ã‹ | âœ… è§£æ±º | [ADR-005](./ADR-005-e2e-scope.md) |
| 1å1ã‚µãƒ¼ãƒãƒ¼ã€slack1ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®åŸå‰‡ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ãƒ•ãƒ©å·¥å¤« | âœ… è§£æ±º | [ADR-002](./ADR-002-routing-mapping.md) |
| FastAPIã®å¸¸æ™‚èµ·å‹•ãŒå‰æã«ãªã£ã¦ã„ã‚‹ã®ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã«è€ƒæ…®ãŒå¿…è¦ | âœ… è§£æ±º | [ADR-003](./ADR-003-always-on-security.md) |

# Oni System v0.3 Design Document

## 1. æ¦‚è¦

v0.3ã¯ã€Œã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå‹ã€ã‹ã‚‰ã€ŒSlackã‚³ãƒãƒ³ãƒ‰/Webhookãƒ™ãƒ¼ã‚¹ã€ã¸ã®ç§»è¡Œã«ä¼´ã†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤§å¹…ãªå¤‰æ›´ã‚’ä¼´ã†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ã™ã€‚

### ä¸»è¦ãªå¤‰æ›´ç‚¹

1. **Slack Integrationã®å¤‰æ›´**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ â†’ Webhookãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•
2. **commitmentæ¦‚å¿µã®è¿½åŠ **: ç¶™ç¶šçš„ãªã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆç®¡ç†
3. **plan/remindã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ã®ç¢ºç«‹**: 24æ™‚é–“ã‚µã‚¤ã‚¯ãƒ«ã®è¨ˆç”»ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ‰
4. **punishmentæ©Ÿæ§‹ã®åˆ·æ–°**: scheduleãƒ†ãƒ¼ãƒ–ãƒ«ãƒ™ãƒ¼ã‚¹ã®ç›£è¦–ãƒ»å®Ÿè¡Œ
5. **Agentçµ±åˆ**: plan_updateã‚¹ã‚­ãƒ«ã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Slack                                   â”‚
â”‚  /base_commit, /stop, /restart, /config                       â”‚
â”‚  BlockKit (buttons, selects, sections)                        â”‚
â”‚  App Home Tab (è©³ç´°è¨­å®šç”¨)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Webhook
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FastAPI Backend                              â”‚
â”‚  /slack/command   : Slackã‚³ãƒãƒ³ãƒ‰å—ä¿¡                          â”‚
â”‚  /slack/interactive: BlockKitã‚¢ã‚¯ã‚·ãƒ§ãƒ³å—ä¿¡                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DB (SQLite + SQLAlchemy)                          â”‚
â”‚  commitments, schedules, action_logs, punishments               â”‚
â”‚  configurations, config_audit_log                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Punishment Worker (1min interval)                    â”‚
â”‚  - pending -> processing -> done/failed                       â”‚
â”‚  - ignore mode detection                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Subprocess Scripts                                â”‚
â”‚  plan.py, remind.py, agent_call.py                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 commitments (æ–°è¦)

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆï¼ˆæ¯æ—¥ä½•æ™‚ã«ä½•ã‚’ã‚„ã‚‹ã‹ï¼‰ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

| column       | type       | note                     |
| ------------ | ---------- | ------------------------ |
| id           | uuid       | PK                       |
| user_id      | uuid       | (å°†æ¥ã®ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨)  |
| time         | time       | å®Ÿè¡Œæ™‚é–“ (HH:MM:SS)      |
| task         | text       | ã‚¿ã‚¹ã‚¯å†…å®¹               |
| active       | boolean    | æœ‰åŠ¹ãƒ•ãƒ©ã‚°               |
| created_at   | datetime   | JST                      |
| updated_at   | datetime   | JST                      |

### 3.2 schedules (å†è¨­è¨ˆ)

å…¨ã¦ã®å®Ÿè¡Œäºˆå®šã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

| column       | type                                                       | note      |
| ------------ | ---------------------------------------------------------- | --------- |
| id           | uuid                                                       | PK        |
| user_id      | uuid                                                       |           |
| event_type   | enum(plan, remind)                                         |           |
| run_at       | datetime(JST)                                              |           |
| state        | enum(pending, processing, done, skipped, failed, canceled) |           |
| thread_ts    | string                                                     | Slackã‚¹ãƒ¬ãƒƒãƒ‰ |
| comment      | text                                                       | YES/NOã‚³ãƒ¡ãƒ³ãƒˆ |
| yes_comment  | text                                                       | YESæ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ |
| no_comment   | text                                                       | NOæ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ |
| retry_count  | int                                                        | default 0 |
| created_at   | datetime                                                   |           |
| updated_at   | datetime                                                   |           |

### åˆ¶ç´„
- (user_id, date(run_at), event_type=plan) UNIQUE

### 3.3 action_logs (å†è¨­è¨ˆ)

è¡Œå‹•ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

| column       | type                                              | note      |
| ------------ | ------------------------------------------------- | --------- |
| id           | uuid                                              | PK        |
| schedule_id  | uuid                                              | FK        |
| result       | enum(YES, NO, AUTO_IGNORE)                        |           |
| created_at   | datetime                                          | JST       |

### 3.4 punishments (æ–°è¦)

ç½°å®Ÿè¡Œè¨˜éŒ²ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

| column       | type                    | note      |
| ------------ | ----------------------- | --------- |
| id           | uuid                    | PK        |
| schedule_id  | uuid                    | FK        |
| mode         | enum(ignore, no)         |           |
| count        | int                     |           |
| created_at   | datetime                | JST       |

### åˆ¶ç´„
- UNIQUE(schedule_id, mode, count)

### 3.5 configurations (æ–°è¦)

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´å¯èƒ½ãªè¨­å®šå€¤ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

| column       | type                    | note                      |
| ------------ | ----------------------- | ------------------------- |
| id           | uuid                    | PK                        |
| user_id      | uuid                    |                           |
| key          | varchar(100)            | è¨­å®šã‚­ãƒ¼                  |
| value        | text                    | è¨­å®šå€¤(JSONæ–‡å­—åˆ—)        |
| value_type   | enum(int, float, str, json, bool) | ãƒ‡ãƒ¼ã‚¿å‹ |
| description  | text                    | èª¬æ˜æ–‡                    |
| default_value| text                    | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤               |
| min_value    | float                   | æœ€å°å€¤(int/floatç”¨)        |
| max_value    | float                   | æœ€å¤§å€¤(int/floatç”¨)        |
| valid_values | json                    | æœ‰åŠ¹å€¤ãƒªã‚¹ãƒˆ(åˆ—æŒ™å‹ç”¨)     |
| version      | int                     | æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ç”¨            |
| created_at   | datetime                | JST                       |
| updated_at   | datetime                | JST                       |

### åˆ¶ç´„
- UNIQUE(user_id, key)

### 3.6 config_audit_log (æ–°è¦)

è¨­å®šå¤‰æ›´ã®ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

| column       | type                    | note                      |
| ------------ | ----------------------- | ------------------------- |
| id           | uuid                    | PK                        |
| config_key   | varchar(100)            | å¤‰æ›´ã•ã‚ŒãŸè¨­å®šã‚­ãƒ¼          |
| old_value    | text                    | å¤‰æ›´å‰ã®å€¤                |
| new_value    | text                    | å¤‰æ›´å¾Œã®å€¤                |
| changed_by   | varchar(50)             | Slack user_id             |
| changed_at   | datetime                | JST                       |
| change_source| varchar(20)            | slack_command, rollbackç­‰   |

---

## 4. APIè¨­è¨ˆ (FastAPI)

### 4.1 Slack Webhook Endpoints

#### POST /slack/command
Slackã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ã€‚

**ã‚³ãƒãƒ³ãƒ‰ç¨®åˆ¥:**
- `/base_commit`: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆç™»éŒ²UIã‚’è¿”å´
- `/stop`: Punishmentæ©Ÿæ§‹ã‚’åœæ­¢
  - å®Ÿè£…: `SYSTEM_PAUSED`è¨­å®šå€¤ã‚’`true`ã«æ›´æ–°
  - Workerã¯å„ã‚µã‚¤ã‚¯ãƒ«é–‹å§‹æ™‚ã«`SYSTEM_PAUSED`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€`true`ã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
- `/restart`: Punishmentæ©Ÿæ§‹ã‚’å†é–‹
  - å®Ÿè£…: `SYSTEM_PAUSED`è¨­å®šå€¤ã‚’`false`ã«æ›´æ–°

#### POST /slack/interactive
Interactive Components (modal submit, button click) ã‚’å‡¦ç†ã™ã‚‹ã€‚

**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥:**
- `commitment_submit`: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆç™»éŒ²
- `plan_submit`: planã‚¿ã‚¹ã‚¯ã®ã‚„ã‚‹/ã‚„ã‚‰ãªã„é¸æŠ
- `yes_button`: remindã®YESãƒœã‚¿ãƒ³
- `no_button`: remindã®NOãƒœã‚¿ãƒ³
- `config_submit`: è¨­å®šå€¤ä¿å­˜
- `config_tab_change`: è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
- `config_reset_confirm`: è¨­å®šãƒªã‚»ãƒƒãƒˆç¢ºèª

### 4.2 å†…éƒ¨API (Workerã‹ã‚‰ä½¿ç”¨)

#### POST /internal/execute/{event_type}
WorkerãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’é€šçŸ¥ã™ã‚‹ã€‚

#### GET /internal/config/{key}
WorkerãŒæœ€æ–°ã®è¨­å®šå€¤ã‚’å–å¾—ã™ã‚‹ã€‚
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥: Workerã¯60ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
- DBæ›´æ–°æ™‚ã®é€šçŸ¥: ä¸è¦ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ï¼‰

---

## 5. Workerè¨­è¨ˆ

### 5.1 Punishment Worker

1åˆ†é–“éš”ã§å‹•ä½œã™ã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã€‚

#### å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
```
1. schedulesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ pending AND run_at <= now ã‚’å–å¾—
2. 1ä»¶ã®ã¿ processing ã«åŸå­çš„æ›´æ–° (SELECT FOR UPDATE)
3. event_type ã«å¿œã˜ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ
4. æˆåŠŸ â†’ done
5. å¤±æ•— â†’ failed (retry_count < 3ãªã‚‰å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
```

#### Ignore Modeæ¤œçŸ¥
```
1. pending AND run_at <= now ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã§æ¤œçŸ¥
2. ignore_time = (now - run_at) // IGNORE_INTERVAL
3. punishmentsãƒ†ãƒ¼ãƒ–ãƒ«ã« (schedule_id, mode=ignore, count=ignore_time) ãŒå­˜åœ¨ã—ãªã„å ´åˆå®Ÿè¡Œ
4. ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :
   - ignore_time == 1: vibe: 100
   - ignore_time > 1: zap: min(35 + (10 * (ignore_time - 2)), 100)
   - zap == 100: state â†’ canceled, è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²
```

### 5.2 Subprocess Scripts

#### scripts/plan.py
- BlockKitå½¢å¼ã§24æ™‚é–“åˆ†ã®äºˆå®šã‚’Slackã«æŠ•ç¨¿
- thread_tsã‚’ä¿å­˜

#### scripts/remind.py
- BlockKitå½¢å¼ã§æ¿€åŠ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + YES/NOãƒœã‚¿ãƒ³ã‚’æŠ•ç¨¿
- thread_tsã‚’ä¿å­˜

#### scripts/agent_call.py
- `echo {plan_prompt} | codex exec plan_update` ã‚’å®Ÿè¡Œ
- çµæœã‚’schedule.yes_comment/no_comment/commentã«ä¿å­˜

---

## 6. ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨­è¨ˆ

### 6.1 å†åˆ©ç”¨å¯èƒ½ãªæ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ä»¥ä¸‹ã¯v0.2ã‹ã‚‰ãã®ã¾ã¾/ä¸€éƒ¨ä¿®æ­£ã§å†åˆ©ç”¨å¯èƒ½:

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ         | ç”¨é€”           | æ”¹ä¿®å†…å®¹                      |
| ----------------- | -------------- | ----------------------------- |
| pavlok.py         | Pavlok APIå‘¼å‡º | å¤‰æ›´ãªã—                       |
| slack.py          | Slack APIå‘¼å‡º  | BlockKitå¯¾å¿œè¿½åŠ                |
| behavior_log.py   | è¡Œå‹•ãƒ­ã‚°è¨˜éŒ²   | action_logsãƒ†ãƒ¼ãƒ–ãƒ«å¯¾å¿œ        |

### 6.2 æ–°è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ         | ç”¨é€”                           |
| ----------------- | ------------------------------ |
| plan.py          | planã‚¤ãƒ™ãƒ³ãƒˆå®Ÿè¡Œ               |
| remind.py        | remindã‚¤ãƒ™ãƒ³ãƒˆå®Ÿè¡Œ             |
| agent_call.py    | Agentå‘¼å‡º                      |
| worker.py        | Punishment Workerãƒ¡ã‚¤ãƒ³        |
| init_db.py       | DBåˆæœŸåŒ–                       |

---

## 7. ãƒ•ãƒ­ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³

### 7.1 init ãƒ•ãƒ­ãƒ¼

```
User: /base_commit
  â†’ Slack Modalè¡¨ç¤º (commitmentæ–°è¦ç™»éŒ²/ç·¨é›†)
User: Modalé€ä¿¡
  â†’ Backend: commitmentsãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
  â†’ Backend: ä»Šæ—¥ã®plan eventãŒãªã‘ã‚Œã°ç™»éŒ²
  â†’ Slack: å®Œäº†é€šçŸ¥
```

### 7.2 plan ãƒ•ãƒ­ãƒ¼

```
Worker: schedule.event_type=plan && pending && run_at <= now
  â†’ state = processing
  â†’ scripts/plan.py å®Ÿè¡Œ
    â†’ Slack: ã€Œä»Šæ—¥ã®äºˆå®šã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€ï¼‹ãƒœã‚¿ãƒ³ã‚’æŠ•ç¨¿
  â†’ å¾…æ©Ÿ...
User: ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
  â†’ Slack: ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãï¼ˆ24æ™‚é–“åˆ†ã®äºˆå®šå…¥åŠ›UIï¼‰
User: é€ä¿¡ãƒœã‚¿ãƒ³æŠ¼ä¸‹
  â†’ Backend: plan_apiå‡¦ç†ï¼ˆview_submissionã‚¤ãƒ™ãƒ³ãƒˆï¼‰
    â†’ å¯¾è±¡plan: state = done
    â†’ ã‚„ã‚‹: remind eventã‚’schedulesã«INSERT
    â†’ ã‚„ã‚‰ãªã„: action_logsã«è¨˜éŒ²
  â†’ Slack: ç™»éŒ²å®Œäº†é€šçŸ¥ï¼ˆå…ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼‰
  â†’ scripts/agent_call.py å®Ÿè¡Œ
    â†’ Agent: plan_updateã§å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
    â†’ schedule.yes_comment, no_comment, commentã«ä¿å­˜
User: Ã—ãƒœã‚¿ãƒ³ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  â†’ ä½•ã‚‚ã—ãªã„ï¼ˆstateã¯processingã®ã¾ã¾ã€ignoreæ¤œçŸ¥ã§å¯¾å¿œï¼‰
```

> **è¨­è¨ˆæ±ºå®š**:
> - ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ˆ`trigger_id`ãŒå¿…è¦ãªãŸã‚ï¼‰
> - Ã—ã§é–‰ã˜ã¦ã‚‚å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ãªã„ï¼ˆignoreæ¤œçŸ¥ã§å‚¬ä¿ƒï¼‰

### 7.3 remind ãƒ•ãƒ­ãƒ¼

```
Worker: schedule.event_type=remind && pending && run_at <= now
  â†’ state = processing
  â†’ scripts/remind.py å®Ÿè¡Œ
    â†’ Slack: BlockKitã§æ¿€åŠ± + YES/NOãƒœã‚¿ãƒ³ã‚’æ–°è¦æŠ•ç¨¿ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡ã¯ã—ãªã„ï¼‰
    â†’ thread_tsã‚’ä¿å­˜
  â†’ å¾…æ©Ÿ...
User: YESãƒœã‚¿ãƒ³
  â†’ Backend: remind_apiå‡¦ç†
    â†’ action_logs: result=YES ã§INSERT
    â†’ schedule: state = done
    â†’ Slack: æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§yes_commentã‚’æŠ•ç¨¿
User: NOãƒœã‚¿ãƒ³
  â†’ Backend: remind_apiå‡¦ç†
    â†’ action_logs: result=NO ã§INSERT
    â†’ Pavlok API: NOãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
    â†’ Slack: æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§no_commentã‚’æŠ•ç¨¿
```

> **è¨­è¨ˆæ±ºå®š**: remindãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯planã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«ã¯è¿”ä¿¡ã›ãšã€ç‹¬ç«‹ã—ãŸæ–°è¦æŠ•ç¨¿ã¨ã™ã‚‹ã€‚
> ç†ç”±: ã‚¹ãƒ¬ãƒƒãƒ‰ãŒæ·±ããªã‚‹ã¨Slack UIã§ã®è¦–èªæ€§ãŒä½ä¸‹ã™ã‚‹ãŸã‚ã€‚

### 7.4 ignoreãƒ¢ãƒ¼ãƒ‰ ãƒ•ãƒ­ãƒ¼

```
Worker: 1åˆ†é–“éš”ç›£è¦–
  â†’ pendingã§ run_at <= now ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œæŸ»
  â†’ ignore_time = (now - run_at) // IGNORE_INTERVAL
  â†’ punishmentsãƒ†ãƒ¼ãƒ–ãƒ«ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
  â†’ å­˜åœ¨ã—ãªã„å ´åˆ:
    â†’ ignore_time == 1: vibe: 100
    â†’ ignore_time > 1: zap: min(35 + (10 * (ignore_time - 2)), 100)
    â†’ punishmentsã«è¨˜éŒ²
    â†’ value == 100ã®å ´åˆ: state = canceled, action_logsè¨˜éŒ²
```

### 7.5 NOãƒ¢ãƒ¼ãƒ‰ ãƒ•ãƒ­ãƒ¼

```
User: NOãƒœã‚¿ãƒ³æŠ¼ä¸‹
  â†’ action_logsã‹ã‚‰å½“æ—¥ã®NO_countã‚’ç®—å‡º
  â†’ å¼·åº¦è¨ˆç®—:
    - NO_count == 1: value = PAVLOK_VALUE_PUNISHï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50ï¼‰
    - NO_count >= 2: value = min(PAVLOK_VALUE_PUNISH + (10 * (NO_count - 1)), LIMIT_PAVLOK_ZAP_VALUE)
  â†’ punishmentsãƒ†ãƒ¼ãƒ–ãƒ«ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
  â†’ Pavlok APIå®Ÿè¡Œï¼ˆtype=PAVLOK_TYPE_PUNISH, value=è¨ˆç®—å€¤ï¼‰
```

> **è¨­è¨ˆæ±ºå®š**:
> - åˆå›NOæ™‚ã¯`PAVLOK_VALUE_PUNISH`ã‚’ä½¿ç”¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šå¯èƒ½ï¼‰
> - 2å›ç›®ä»¥é™ã¯10ãšã¤å¢—åŠ ã€æœ€å¤§`LIMIT_PAVLOK_ZAP_VALUE`ã§ã‚­ãƒ£ãƒƒãƒ—

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

> è©³ç´°ã¯ [ADR-003: å¸¸æ™‚èµ·å‹•å‰æã®é˜²å¾¡è¨­è¨ˆ](./ADR-003-always-on-security.md) ã‚’å‚ç…§

### 8.1 å¤šå±¤é˜²å¾¡æ§‹æˆ

```
Gateway (Cloudflare Worker)
  â”œâ”€ Slackç½²åæ¤œè¨¼
  â”œâ”€ replayæ”»æ’ƒå¯¾ç­–
  â”œâ”€ ãƒ¬ãƒ¼ãƒˆåˆ¶é™
  â””â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

FastAPI
  â”œâ”€ ç½²åå†æ¤œè¨¼
  â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼èªå¯ (AUTHORIZED_USERS)
  â”œâ”€ å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  â””â”€ /internalä¿è­· (INTERNAL_SECRET)
```

### 8.2 å…·ä½“çš„ãªå¯¾ç­–

1. **Slackç½²åæ¤œè¨¼**: å…¨Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å¿…é ˆ
2. **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–**: SQLAlchemy ORMä½¿ç”¨ã€ãƒã‚¤ãƒ³ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¿…é ˆ
3. **ã‚³ãƒãƒ³ãƒ‰å¼•æ•°åˆ¶é™**:
   - `/stop`, `/restart`: å¼•æ•°ç¦æ­¢
   - `/base_commit`: å…¥åŠ›é•·åˆ¶é™
4. **Idempotency**: Interactive Componentsã®å†é€ä¿¡å¯¾ç­–
5. **/internalä¿è­·**: ãƒ˜ãƒƒãƒ€ãƒ¼ç½²åæ–¹å¼ã§Workerå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã«é™å®š
6. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: slowapiã§å®Ÿè£…

---

## 9. Migrationè¨ˆç”»

### 9.1 DB Migration

```sql
-- æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ç ´æ£„ã—ã¦å†ä½œæˆ
DROP TABLE IF EXISTS schedules;
DROP TABLE IF EXISTS behavior_logs;
DROP TABLE IF EXISTS slack_ignore_events;
DROP TABLE IF EXISTS daily_punishments;
DROP TABLE IF EXISTS pavlok_counts;

-- æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE commitments (...);
CREATE TABLE schedules (...);
CREATE TABLE action_logs (...);
CREATE TABLE punishments (...);
```

### 9.2 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

v0.2ã‹ã‚‰ã®æœ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã¯ãªãã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆã€‚

---

## 10. è¨­å®šç®¡ç†æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ

### 10.1 è¨­å®šç®¡ç†ã®åŸºæœ¬æ–¹é‡

#### 10.1.1 ç’°å¢ƒå¤‰æ•°ã¨è¨­å®šå€¤ã®åˆ†é›¢

**ç’°å¢ƒå¤‰æ•°ï¼ˆ.envã®ã¿ã€Slackã‹ã‚‰å¤‰æ›´ä¸å¯ï¼‰:**

| å¤‰æ•°å | åˆ†é¡ | ç†ç”± |
| ------- | ---- | ---- |
| `DATABASE_URL` | ã‚¤ãƒ³ãƒ•ãƒ© | ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒä¾å­˜ |
| `SLACK_BOT_USER_OAUTH_TOKEN` | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | èªè¨¼æƒ…å ± |
| `SLACK_USER_OAUTH_TOKEN` | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | èªè¨¼æƒ…å ± |
| `SLACK_SIGNING_SECRET` | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | Webhookæ¤œè¨¼ç”¨ |
| `PAVLOK_API_KEY` | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | JWTãƒˆãƒ¼ã‚¯ãƒ³ |
| `INTERNAL_SECRET` | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | /internalä¿è­·ç”¨ï¼ˆADR-003å‚ç…§ï¼‰|
| `AUTHORIZED_USERS` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | èªå¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆï¼ˆADR-003å‚ç…§ï¼‰|
| `TIMEZONE` | ã‚¤ãƒ³ãƒ•ãƒ© | ã‚·ã‚¹ãƒ†ãƒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ |
| `AGENT_MODE` | ã‚¤ãƒ³ãƒ•ãƒ© | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­å®š |

**è¨­å®šå€¤ï¼ˆDB+Slack UIã‹ã‚‰å¤‰æ›´å¯èƒ½ï¼‰:**

> è©³ç´°ã¯ [ADR-004: è¨­å®šå€¤ã®æ¡ç”¨ãƒªã‚¹ãƒˆ](./ADR-004-config-values.md) ã‚’å‚ç…§

| è¨­å®šã‚­ãƒ¼ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | å‹ | ç¯„å›²/æœ‰åŠ¹å€¤ | UIè¡¨ç¤º | èª¬æ˜ |
| -------- | --------- | --- | ---------- | ------ | ---- |
| `PAVLOK_TYPE_PUNISH` | zap | str | zap,beep,vibe | static_select | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç½°ã‚¹ã‚¿ã‚¤ãƒ« |
| `PAVLOK_VALUE_PUNISH` | 50 | int | 0-100 | plain_text_input | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç½°å¼·åº¦ |
| `LIMIT_DAY_PAVLOK_COUNTS` | 100 | int | 1-1000 | plain_text_input | 1æ—¥ã®æœ€å¤§ZAPå›æ•° |
| `LIMIT_PAVLOK_ZAP_VALUE` | 100 | int | 1-100 | plain_text_input | æœ€å¤§ZAPå¼·åº¦(ãƒãƒ¼ãƒ‰ãƒªãƒŸãƒƒãƒˆ) |
| `IGNORE_INTERVAL` | 900 | int | 300-1800 | static_select | ignoreæ¤œçŸ¥é–“éš”(ç§’) |
| `IGNORE_JUDGE_TIME` | 3 | int | 1-30 | plain_text_input | ignoreåˆ¤å®šæ™‚é–“(ç§’) |
| `IGNORE_MAX_RETRY` | 5 | int | 1-20 | plain_text_input | ignoreæœ€å¤§å†è©¦è¡Œå›æ•° |
| `TIMEOUT_REMIND` | 600 | int | 60-3600 | plain_text_input | ãƒªãƒã‚¤ãƒ³ãƒ‰å¿œç­”ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(ç§’) |
| `TIMEOUT_REVIEW` | 600 | int | 60-3600 | plain_text_input | æŒ¯ã‚Šè¿”ã‚Šå¿œç­”ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(ç§’) |
| `RETRY_DELAY` | 5 | int | 1-60 | static_select | å¤±æ•—æ™‚ãƒªãƒˆãƒ©ã‚¤é…å»¶(åˆ†) |
| `SYSTEM_PAUSED` | false | bool | true/false | ãªã— | ç½°åœæ­¢ãƒ•ãƒ©ã‚°ï¼ˆ/stop,/restartã§åˆ¶å¾¡ï¼‰ |

### 10.2 è¨­å®šå€¤å–å¾—ãƒ­ã‚¸ãƒƒã‚¯

```python
# å„ªå…ˆé †ä½: DB > ç’°å¢ƒå¤‰æ•° > ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
def get_config(key: str, default=None):
    # 1. DBã‹ã‚‰å–å¾—
    config = db.query(Configuration).filter_by(key=key).first()
    if config:
        return parse_value(config.value, config.value_type)

    # 2. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
    env_value = os.getenv(key)
    if env_value is not None:
        return parse_env_value(env_value)

    # 3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    return default
```

### 10.3 è¨­å®šå¤‰æ›´ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

1. **Slackç½²åæ¤œè¨¼**: å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å¿…é ˆ
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼**: `AUTHORIZED_USERS` ã§ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆç®¡ç†
3. **å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: å‹ãƒã‚§ãƒƒã‚¯ã€ç¯„å›²ãƒã‚§ãƒƒã‚¯ã€æœ‰åŠ¹å€¤ãƒã‚§ãƒƒã‚¯
4. **å±é™ºãªå¤‰æ›´ã®ç¢ºèª**: ZAPå¼·åº¦80ä»¥ä¸Šã®å ´åˆã¯ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
5. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: åŒä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¸ã®å¤‰æ›´ã¯5åˆ†é–“ã«1å›ã¾ã§
6. **ç›£æŸ»ãƒ­ã‚°**: å…¨å¤‰æ›´ã‚’ `config_audit_log` ã«è¨˜éŒ²

### 10.4 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

| ãƒ¬ãƒ™ãƒ« | ã‚³ãƒãƒ³ãƒ‰ | å‹•ä½œ |
| ------ | -------- | ---- |
| å˜ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | `/config rollback <key>` | æŒ‡å®šã‚­ãƒ¼ã‚’ç›´å‰ã®å€¤ã«æˆ»ã™ |
| å…¨ä½“ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | `/config rollback --version N` | ãƒãƒ¼ã‚¸ãƒ§ãƒ³Nå…¨ä½“ã‚’å¾©å…ƒ |
| ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ | `/config reset` | å®‰å…¨ãªãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«å…¨ãƒªã‚»ãƒƒãƒˆ |

---

## 11. Slack UIãƒ‡ã‚¶ã‚¤ãƒ³è©³ç´°

> **è©³ç´°ä»•æ§˜**: å®Œå…¨ãªBlockKitå®šç¾©ã¯ [v0.3_slack_ui_spec.md](./v0.3_slack_ui_spec.md) ã‚’å‚ç…§

### 11.1 UIè¨­è¨ˆæ–¹é‡

> è©³ç´°ã¯ [v0.3_slack_ui_spec.md](./v0.3_slack_ui_spec.md) ã‚’å‚ç…§

1. **ãƒ¢ãƒ¼ãƒ€ãƒ«æ´»ç”¨**: å…¥åŠ›ãŒå¿…è¦ãªæ“ä½œã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä¸€å…ƒç®¡ç†ï¼ˆ`plain_text_input`ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã®ã¿ä½¿ç”¨å¯èƒ½ï¼‰
2. **ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«å„ªå…ˆ**: å€‹äººå‘ã‘ã®å®Ÿè¡Œçµæœã‚„ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã¯ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§è¡¨ç¤º
3. **ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã¯é€šçŸ¥ã®ã¿**: remind/ignoreé€šçŸ¥ãªã©ã€ãƒãƒ¼ãƒ å…¨ä½“ã«å…±æœ‰ã™ã¹ãæƒ…å ±ã®ã¿ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
4. **å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: ãƒœã‚¿ãƒ³æ“ä½œã«å¯¾ã—ã¦å³åº§ã«å¿œç­”

### 11.2 BlockKitåˆ¶ç´„ã¸ã®å¯¾å‡¦

BlockKitã® `plain_text_input` ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ã®ã¿ä½¿ç”¨å¯èƒ½ã€‚ä»¥ä¸‹ã®æˆ¦ç•¥ã§å¯¾å‡¦ï¼š

| å…¥åŠ›ã‚¿ã‚¤ãƒ— | è§£æ±ºç­– |
|-----------|--------|
| é¸æŠè‚¢ï¼ˆåˆ—æŒ™å‹ï¼‰ | `static_select` ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ä½¿ç”¨ |
| æ•°å€¤ï¼ˆç¯„å›²æŒ‡å®šï¼‰ | `plain_text_input` ã§å…¥åŠ› + ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| ON/OFF | `checkboxes` ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ä½¿ç”¨ |
| ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ | `plain_text_input` ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã§ä½¿ç”¨ |

### 11.3 ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

| ã‚³ãƒãƒ³ãƒ‰ | UIæ–¹å¼ | è¡¨ç¤ºã‚¿ã‚¤ãƒ— |
| -------- | ------ | ---------- |
| `/base_commit` | BlockKit | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/stop` | BlockKit (ç¢ºèªä»˜ã) | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/restart` | BlockKit | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/config` | BlockKit (ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ) | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/config view` | BlockKit (ä¸€è¦§) | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/config reset` | BlockKit (ç¢ºèªä»˜ã) | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/config rollback <key>` | BlockKit | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |
| `/audit` | BlockKit (å±¥æ­´ä¸€è¦§) | ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ« |

### 11.4 Workerã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥

| ã‚¤ãƒ™ãƒ³ãƒˆ | UIæ–¹å¼ | è¡¨ç¤ºã‚¿ã‚¤ãƒ— |
|----------|--------| ----------|
| planæŠ•ç¨¿ | BlockKit (äºˆå®šä¸€è¦§ + ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³) | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ |
| remindæŠ•ç¨¿ | BlockKit (YES/NOãƒœã‚¿ãƒ³) | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ |
| ignoreæ¤œçŸ¥ | BlockKit (å¿œç­”å‚¬ä¿ƒ) | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ |
| å¿œç­”å®Œäº†é€šçŸ¥ | BlockKit (ã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡) | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ |

### 11.5 è¨­å®šå¤‰æ›´UIæ§‹æˆ

```
/config
  â”œâ”€â”€ ã‚¿ãƒ–ãƒœã‚¿ãƒ³ç¾¤ [ç½°è¨­å®š] [Ignore] [Timeout] [è©³ç´°]
  â”œâ”€â”€ ç¾åœ¨å€¤ä¸€è¦§
  â”‚   â”œâ”€â”€ è¨­å®šé …ç›® + [å¤‰æ›´]ãƒœã‚¿ãƒ³
  â”‚   â””â”€â”€ ...
  â””â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ [ãƒªã‚»ãƒƒãƒˆ] [å±¥æ­´]

[å¤‰æ›´]ã‚¯ãƒªãƒƒã‚¯
  â””â”€â”€ ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ OR +/- èª¿æ•´
      â””â”€â”€ [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]
```

### 11.6 Home Tabï¼ˆä»£æ›¿UIï¼‰

App Homeã‚¿ãƒ–ã‚’å®Œå…¨ãªè¨­å®šç®¡ç†UIã¨ã—ã¦æä¾›ï¼š

- ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆç®¡ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¯èƒ½ï¼‰
- å…¨è¨­å®šã®ç·¨é›†
- çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆä»Šæ—¥ã®ç½°å›æ•°ç­‰ï¼‰

**ä½¿ã„åˆ†ã‘**:
- `/config` â†’ ç°¡æ˜“ç¢ºèªãƒ»å¤‰æ›´
- App Home â†’ è©³ç´°è¨­å®šãƒ»ä¸€æ‹¬ç·¨é›†

---

## 12. å®Ÿè£…ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆTDDé–‹ç™ºï¼‰

### 12.0 é–‹ç™ºãƒ¡ãƒ³ãƒãƒ¼å®šç¾©

| ãƒ­ãƒ¼ãƒ« | æ‹…å½“ç¯„å›² | ä¸»ãªè²¬ä»» | å‚™è€ƒ |
|--------|---------|---------|---------|
| **PM** | å…¨ä½“é€²æ—ç®¡ç†ã€ã‚¿ã‚¹ã‚¯å‰²å½“ã€ãƒ–ãƒ­ãƒƒã‚«ãƒ¼è§£æ¶ˆ | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ã€ä»•æ§˜ç¢ºèª | - |
| **Backend** | DB/Worker/FastAPIå®Ÿè£… | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ãƒ†ã‚¹ãƒˆå®Ÿè£… | - |
| **Slack UI** | BlockKitå®Ÿè£…ã€Slack APIé€£æº | UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ | - |
| **Architect** | è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ | å“è³ªä¿è¨¼ã€ADRéµå®ˆç¢ºèª | ä½¿ã‚ã‚Œã¦ãªã„ã‚³ãƒ¼ãƒ‰ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ã€ä¿å®ˆæ€§ã®æ‚ªã„ã‚³ãƒ¼ãƒ‰ã¯å—ã‘ä»˜ã‘ã¾ã›ã‚“ã€‚ |

### 12.1 Skillsè¦ä»¶å®šç¾©

> Claude Codeã®skillsæ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã¦é–‹ç™ºåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã‚‹
> **Status: âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿**ï¼ˆ2026-02-14ï¼‰

| ãƒ¡ãƒ³ãƒãƒ¼ | Skill | ç”¨é€” |
|---------|-------|------|
| **PM** | `mem-search` | éå»ã®è¨­è¨ˆæ±ºå®šã‚’æ¤œç´¢ |
| **Backend** | `webapp-testing` | Playwrightã‚’ä½¿ã£ãŸAPIãƒ†ã‚¹ãƒˆ |
| | `mem-search` | è¨­è¨ˆåˆ¤æ–­ã®å±¥æ­´æ¤œç´¢ |
| **Slack UI** | `frontend-design` | BlockKitãƒ‡ã‚¶ã‚¤ãƒ³å“è³ªå‘ä¸Š |
| | `webapp-testing` | UIãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ– |
| **Architect** | `doc-coauthoring` | ADR/è¨­è¨ˆæ›¸ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| **å…¨å“¡** | `find-skills` | è¿½åŠ ã‚¹ã‚­ãƒ«ã®æ¤œç´¢ |

#### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿Skillsä¸€è¦§

```
~/.claude/skills/
â”œâ”€â”€ doc-coauthoring    â†’ ADR/è¨­è¨ˆæ›¸ã®æ§‹é€ åŒ–ãƒ¬ãƒ“ãƒ¥ãƒ¼
â”œâ”€â”€ find-skills        â†’ æ–°è¦ã‚¹ã‚­ãƒ«ã®æ¤œç´¢ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
â”œâ”€â”€ frontend-design    â†’ é«˜å“è³ªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³
â”œâ”€â”€ mem-search         â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã¾ãŸãè¨˜æ†¶æ¤œç´¢
â”œâ”€â”€ speech             â†’ ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’
â””â”€â”€ webapp-testing     â†’ Playwright Webã‚¢ãƒ—ãƒªãƒ†ã‚¹ãƒˆ
```

---

### Phase 0: ãƒ†ã‚¹ãƒˆåŸºç›¤æ§‹ç¯‰ï¼ˆPM + Backendï¼‰

> TDDé–‹ç™ºã®å‰æã¨ã—ã¦æœ€åˆã«ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ•´ãˆã‚‹

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ |
|---|--------|------|----------------|
| 0.1 | pytestç’°å¢ƒæ§‹ç¯‰ã€conftest.pyä½œæˆ | Backend | - |
| 0.2 | DB fixturesä½œæˆï¼ˆin-memory SQLiteï¼‰ | Backend | - |
| 0.3 | Mockã‚¯ãƒ©ã‚¹ä½œæˆï¼ˆSlackClient, PavlokClientï¼‰ | Backend | - |
| 0.4 | CI/CDè¨­å®šï¼ˆGitHub Actionsï¼‰ | PM | - |

---

### Phase 1: DB & Modelsï¼ˆBackend + Architect Reviewï¼‰

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | TDDã‚µã‚¤ã‚¯ãƒ« |
|---|--------|------|------------|
| 1.1 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: models/test_commitments.py | Backend | Red |
| 1.2 | âœ… å®Ÿè£…: models/commitments.py | Backend | Green |
| 1.3 | ğŸ”§ ãƒªãƒ•ã‚¡ã‚¯ã‚¿: ãƒ¢ãƒ‡ãƒ«æ•´ç† | Backend | Refactor |
| 1.4 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: models/test_schedules.pyï¼ˆstateé·ç§»å«ã‚€ï¼‰ | Backend | Red |
| 1.5 | âœ… å®Ÿè£…: models/schedules.py | Backend | Green |
| 1.6 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: models/test_configurations.py | Backend | Red |
| 1.7 | âœ… å®Ÿè£…: models/configurations.py | Backend | Green |
| 1.8 | âœ… å®Ÿè£…: init_db.pyï¼ˆseed dataï¼‰ | Backend | - |
| 1.9 | ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼: DBè¨­è¨ˆå¦¥å½“æ€§ç¢ºèª | Architect | - |

---

### Phase 2: Core Scriptsï¼ˆBackend + Slack UIï¼‰

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | TDDã‚µã‚¤ã‚¯ãƒ« |
|---|--------|------|------------|
| 2.1 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_slack.pyï¼ˆBlockKitç”Ÿæˆï¼‰ | Slack UI | Red |
| 2.2 | âœ… å®Ÿè£…: slack.py BlockKitå¯¾å¿œ | Slack UI | Green |
| 2.3 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_pavlok.py | Backend | Red |
| 2.4 | âœ… å®Ÿè£…: pavlok.pyï¼ˆæ—¢å­˜æµç”¨ï¼‰ | Backend | Green |
| 2.5 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_behavior_log.py | Backend | Red |
| 2.6 | âœ… å®Ÿè£…: behavior_log.pyï¼ˆaction_logså¯¾å¿œï¼‰ | Backend | Green |

---

### Phase 3: Backend APIï¼ˆBackend + Slack UI + Architect Reviewï¼‰

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | TDDã‚µã‚¤ã‚¯ãƒ« |
|---|--------|------|------------|
| 3.1 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_signature_middleware.py | Backend | Red |
| 3.2 | âœ… å®Ÿè£…: Slackç½²åæ¤œè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ | Backend | Green |
| 3.3 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_internal_protection.py | Backend | Red |
| 3.4 | âœ… å®Ÿè£…: /internalä¿è­·ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ | Backend | Green |
| 3.5 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_command_api.pyï¼ˆ/base_commit, /stop, /restartï¼‰ | Backend | Red |
| 3.6 | âœ… å®Ÿè£…: /slack/command ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | Backend | Green |
| 3.7 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_config_api.py | Backend | Red |
| 3.8 | âœ… å®Ÿè£…: config_api CRUD | Backend | Green |
| 3.9 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_interactive_api.pyï¼ˆplan_submit, remind, ignoreï¼‰ | Backend + Slack UI | Red |
| 3.10 | âœ… å®Ÿè£…: /slack/interactive ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | Backend + Slack UI | Green |
| 3.11 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_plan_api.pyï¼ˆremindç™»éŒ²ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ | Backend | Red |
| 3.12 | âœ… å®Ÿè£…: plan_api, remind_api | Backend | Green |
| 3.13 | ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼: APIè¨­è¨ˆãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª | Architect | - |

---

### Phase 4: Workerï¼ˆBackend + Architect Reviewï¼‰

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | TDDã‚µã‚¤ã‚¯ãƒ« |
|---|--------|------|------------|
| 4.1 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_config_cache.py | Backend | Red |
| 4.2 | âœ… å®Ÿè£…: è¨­å®šã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿæ§‹ï¼ˆ60ç§’TTLï¼‰ | Backend | Green |
| 4.3 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_ignore_mode.pyï¼ˆæ¤œçŸ¥ãƒ»å¼·åº¦è¨ˆç®—ï¼‰ | Backend | Red |
| 4.4 | âœ… å®Ÿè£…: ignore_modeæ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ | Backend | Green |
| 4.5 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_no_mode.pyï¼ˆå¼·åº¦è¨ˆç®—ï¼‰ | Backend | Red |
| 4.6 | âœ… å®Ÿè£…: no_modeæ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ | Backend | Green |
| 4.7 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_worker_main.pyï¼ˆãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼‰ | Backend | Red |
| 4.8 | âœ… å®Ÿè£…: worker.py ãƒ¡ã‚¤ãƒ³ | Backend | Green |
| 4.9 | âœ… å®Ÿè£…: scripts/plan.py, remind.py | Backend | - |
| 4.10 | ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼: Workerè¨­è¨ˆãƒ»ä¸¦è¡Œæ€§ç¢ºèª | Architect | - |

---

### Phase 5: BlockKit UIå®Ÿè£…ï¼ˆSlack UI + Architect Reviewï¼‰

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | TDDã‚µã‚¤ã‚¯ãƒ« |
|---|--------|------|------------|
| 5.1 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_blockkit_plan.pyï¼ˆplané–‹å§‹é€šçŸ¥ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ | Slack UI | Red |
| 5.2 | âœ… å®Ÿè£…: plan BlockKit JSON | Slack UI | Green |
| 5.3 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_blockkit_remind.py | Slack UI | Red |
| 5.4 | âœ… å®Ÿè£…: remind BlockKit JSON | Slack UI | Green |
| 5.5 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_blockkit_ignore.py | Slack UI | Red |
| 5.6 | âœ… å®Ÿè£…: ignore BlockKit JSON | Slack UI | Green |
| 5.7 | âŒ ãƒ†ã‚¹ãƒˆä½œæˆ: test_blockkit_config.py | Slack UI | Red |
| 5.8 | âœ… å®Ÿè£…: config BlockKit JSON | Slack UI | Green |
| 5.9 | ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼: UI/UXæ•´åˆæ€§ç¢ºèª | Architect | - |

---

### Phase 6: Integration & E2Eï¼ˆå…¨å“¡ï¼‰

| # | ã‚¿ã‚¹ã‚¯ | æ‹…å½“ | å‚™è€ƒ |
|---|--------|------|------|
| 6.1 | Integration Test: å…¨APIçµåˆãƒ†ã‚¹ãƒˆ | Backend | è‡ªå‹•åŒ– |
| 6.2 | æ‰‹å‹•ãƒ†ã‚¹ãƒˆ: Slackå®Ÿæ©Ÿç¢ºèª | Slack UI + PM | checklist |
| 6.3 | æ‰‹å‹•ãƒ†ã‚¹ãƒˆ: Pavlokå®Ÿæ©Ÿç¢ºèª | Backend + PM | checklist |
| 6.4 | Agentçµ±åˆ: plan_updateã‚¹ã‚­ãƒ«ä½œæˆ | PM + Backend | - |
| 6.5 | ãƒ‡ãƒ—ãƒ­ã‚¤: æœ¬ç•ªç’°å¢ƒåæ˜  | PM | - |
| 6.6 | ğŸ“‹ æœ€çµ‚ãƒ¬ãƒ“ãƒ¥ãƒ¼: å…¨ä½“å“è³ªç¢ºèª | Architect | - |

> è©³ç´°ã¯ [ADR-005: E2Eç¯„å›²ã®å®šç¾©](./ADR-005-e2e-scope.md) ã‚’å‚ç…§

---

## 13. ç’°å¢ƒå¤‰æ•°

```bash
# ============ ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã®ã¿ã€å¤‰æ›´ä¸å¯ï¼‰============
DATABASE_URL=sqlite:///./app.db
TIMEZONE=Asia/Tokyo
AGENT_MODE=codex_cli

# ============ Slackèªè¨¼ï¼ˆç’°å¢ƒå¤‰æ•°ã®ã¿ã€å¤‰æ›´ä¸å¯ï¼‰============
SLACK_BOT_USER_OAUTH_TOKEN=xoxb-...
SLACK_USER_OAUTH_TOKEN=xoxp-...
SLACK_SIGNING_SECRET=...

# ============ Pavlokèªè¨¼ï¼ˆç’°å¢ƒå¤‰æ•°ã®ã¿ã€å¤‰æ›´ä¸å¯ï¼‰============
PAVLOK_API_KEY=...

# ============ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆç’°å¢ƒå¤‰æ•°ã®ã¿ã€å¤‰æ›´ä¸å¯ï¼‰============
# /internalä¿è­·ç”¨ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆä»»æ„ã®æ–‡å­—åˆ—ï¼‰
INTERNAL_SECRET=your-internal-secret-key
# èªå¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
AUTHORIZED_USERS=U03JBULT484
```

---

## ä»˜éŒ²A: è¨­å®šç®¡ç†æ©Ÿèƒ½ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

### UC-1: ç½°å¼·åº¦ã®èª¿æ•´

**ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ã€Œæœ€è¿‘ç½°ãŒç”˜ã™ãã‚‹æ°—ãŒã™ã‚‹ã€

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼: `/config` ã‚’å®Ÿè¡Œ
2. Slack: ç½°è¨­å®šã‚¿ãƒ–ä»˜ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼: `ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç½°å¼·åº¦` ã‚’ 50 â†’ 70 ã«å¤‰æ›´
4. Slack: "80ä»¥ä¸Šã¯éå¸¸ã«å¼·åŠ›ã§ã™" ã¨ã„ã†è­¦å‘Šã‚’è¡¨ç¤º
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãã®ã¾ã¾ä¿å­˜
6. Backend: `configurations` ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã€`config_audit_log` ã«è¨˜éŒ²
7. Worker: æ¬¡å›ã®ã‚µã‚¤ã‚¯ãƒ«(60ç§’ä»¥å†…)ã«æ–°ã—ã„å€¤ã‚’é©ç”¨

### UC-2: ç·Šæ€¥æ™‚ã®ç½°åœæ­¢

**ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ã€Œå®¶æ—ãŒæ¥ã‚‹ã‹ã‚‰1æ™‚é–“ã ã‘ç½°æ­¢ã‚ãŸã„ã€

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼: `/stop` ã‚’å®Ÿè¡Œ
2. Backend: Workerã«åœæ­¢ã‚·ã‚°ãƒŠãƒ«é€ä¿¡
3. Slack: "ç½°æ©Ÿæ§‹ã‚’åœæ­¢ã—ã¾ã—ãŸ" ã‚’è¿”ä¿¡
4. 1æ™‚é–“å¾Œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `/restart` ã§å†é–‹

### UC-3: è¨­å®šã®é–“é•ã„ã«æ°—ã¥ã„ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

**ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ã€Œã‚„ã°ã„ã€IGNORE_INTERVALã‚’60ç§’ã«ã—ã™ããŸã€

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼: `/config rollback IGNORE_INTERVAL` ã‚’å®Ÿè¡Œ
2. Backend: `config_audit_log` ã‹ã‚‰ç›´å‰ã®å€¤ã‚’å–å¾—
3. Backend: å…ƒã®å€¤(900)ã§æ›´æ–°ã€ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²
4. Slack: "IGNORE_INTERVALã‚’900ã«æˆ»ã—ã¾ã—ãŸ" ã‚’è¿”ä¿¡

---

## ä»˜éŒ²B: è¨­å®šç®¡ç†ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     /config      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ BlockKit (ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ - ã‚¿ãƒ–é¸æŠãƒœã‚¿ãƒ³         â”‚
                                  â”‚ - è¨­å®šå€¤ä¸€è¦§             â”‚
                                  â”‚ - [å¤‰æ›´]ãƒœã‚¿ãƒ³           â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     [å¤‰æ›´]ã‚¯ãƒªãƒƒã‚¯                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ BlockKitæ›´æ–° (ãƒ—ãƒªã‚»ãƒƒãƒˆ OR +/- ãƒœã‚¿ãƒ³)                  â”‚   â”‚
â”‚  â”‚ - ãƒ—ãƒªã‚»ãƒƒãƒˆå€¤: 25, 50, 75, 100                         â”‚   â”‚
â”‚  â”‚ - å¾®èª¿æ•´: -10, -5, -1, +1, +5, +10                      â”‚   â”‚
â”‚  â”‚ - [ä¿å­˜] [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ [ä¿å­˜]
                               v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FastAPI Backend                                â”‚
â”‚  1. Slackç½²åæ¤œè¨¼                                            â”‚
â”‚  2. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒã‚§ãƒƒã‚¯                                     â”‚
â”‚  3. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³                                        â”‚
â”‚  4. å±é™ºå€¤ãƒã‚§ãƒƒã‚¯(80ä»¥ä¸Šâ†’è­¦å‘Šè¡¨ç¤º)                          â”‚
â”‚  5. DBæ›´æ–°(configurations + config_audit_log)                â”‚
â”‚  6. ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«ã§å®Œäº†é€šçŸ¥                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Worker Process                                â”‚
â”‚  - 60ç§’ã‚­ãƒ£ãƒƒã‚·ãƒ¥                                            â”‚
â”‚  - æ¬¡å›ã‚µã‚¤ã‚¯ãƒ«ã§æ–°å€¤ã‚’åæ˜                                   â”‚
â”‚  - DBå–å¾—å¤±æ•—æ™‚ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ç”¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä»˜éŒ²C: BlockKitã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§

### C.1 action_id è¨­è¨ˆè¦ç´„

```
{æ©Ÿèƒ½}_{ã‚¢ã‚¯ã‚·ãƒ§ãƒ³}[_{è©³ç´°}]
```

### C.2 ä¸»ãªaction_id

| action_id | ç”¨é€” | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|-----------|------|-----------|
| `commitment_add` | ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆè¿½åŠ  | - |
| `commitment_edit` | ç·¨é›† | value: commitment_id |
| `commitment_delete` | å‰Šé™¤ | value: commitment_id |
| `tab_punish` | è¨­å®šã‚¿ãƒ–:ç½° | - |
| `tab_ignore` | è¨­å®šã‚¿ãƒ–:Ignore | - |
| `edit_{CONFIG_KEY}` | è¨­å®šç·¨é›†é–‹å§‹ | - |
| `preset_{value}` | ãƒ—ãƒªã‚»ãƒƒãƒˆé¸æŠ | - |
| `adjust_{delta}` | æ•°å€¤èª¿æ•´ | - |
| `save_value` | è¨­å®šä¿å­˜ | - |
| `remind_yes` | remind YES | value: schedule_id |
| `remind_no` | remind NO | value: schedule_id |
