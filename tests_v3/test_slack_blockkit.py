"""
v0.3 BlockKit UI Tests

Tests for BlockKit JSON generation for Slack UI components.
Following TDD: Red -> Green -> Refactor
"""
import pytest
from datetime import datetime


class TestBlockKitBaseCommit:
    """Test /base_commit modal UI"""

    def test_base_commit_modal_structure(self):
        """Base commit modal should have correct structure"""
        from backend.slack_ui import base_commit_modal

        commitments = [
            {"id": "1", "time": "07:00", "task": "æœã®çž‘æƒ³"},
            {"id": "2", "time": "09:00", "task": "ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯"},
            {"id": "3", "time": "22:00", "task": "æŒ¯ã‚Šè¿”ã‚Š"},
        ]

        modal = base_commit_modal(commitments)

        assert modal["type"] == "modal"
        assert modal["callback_id"] == "base_commit_submit"
        assert "ðŸ“‹" in modal["title"]["text"]
        assert modal["submit"]["text"] == "é€ä¿¡"

        # Should have at least 3 commitment rows
        blocks = modal["blocks"]
        assert len(blocks) >= 3 * 3 + 3  # 3 commitments * 3 blocks + header/divider/footer

    def test_base_commit_modal_with_empty_commitments(self):
        """Modal should show minimum 3 rows even with no commitments"""
        from backend.slack_ui import base_commit_modal

        modal = base_commit_modal([])

        blocks = modal["blocks"]
        # Should still have input blocks for 3 commitments
        task_blocks = [b for b in blocks if b.get("block_id", "").startswith("commitment_")]
        assert len(task_blocks) == 3

    def test_base_commit_modal_action_ids(self):
        """Modal should have correct action_ids"""
        from backend.slack_ui import base_commit_modal

        modal = base_commit_modal([])

        # Check add/remove row buttons
        actions_blocks = [b for b in modal["blocks"] if b.get("type") == "actions"]
        add_button = None
        remove_button = None
        for block in actions_blocks:
            for elem in block.get("elements", []):
                if elem.get("action_id") == "commitment_add_row":
                    add_button = elem
                if elem.get("action_id") == "commitment_remove_row":
                    remove_button = elem

        assert add_button is not None
        assert add_button["text"]["text"] == "+ è¿½åŠ "
        assert add_button["style"] == "primary"
        assert remove_button is not None
        assert remove_button["text"]["text"] == "- å‰Šé™¤"
        assert remove_button["style"] == "danger"

    def test_base_commit_modal_task_inputs_are_optional(self):
        """Task inputs should be optional so blank added rows don't fail validation."""
        from backend.slack_ui import base_commit_modal

        modal = base_commit_modal([])
        task_blocks = [
            b for b in modal["blocks"]
            if b.get("block_id", "").startswith("commitment_")
        ]
        assert len(task_blocks) >= 3
        for block in task_blocks:
            assert block.get("optional") is True


class TestBlockKitStopRestart:
    """Test /stop and /restart notification UI"""

    def test_stop_notification_ephemeral(self):
        """Stop notification should be ephemeral"""
        from backend.slack_ui import stop_notification

        blocks = stop_notification()

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "section"
        assert "â¸ï¸" in blocks[0]["text"]["text"]
        assert "é¬¼ã‚³ãƒ¼ãƒã‚’åœæ­¢ã—ã¾ã—ãŸ" in blocks[0]["text"]["text"]
        assert "/restart" in blocks[0]["text"]["text"]

    def test_restart_notification_ephemeral(self):
        """Restart notification should be ephemeral"""
        from backend.slack_ui import restart_notification

        blocks = restart_notification()

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "section"
        assert "â–¶ï¸" in blocks[0]["text"]["text"]
        assert "é¬¼ã‚³ãƒ¼ãƒã‚’å†é–‹ã—ã¾ã—ãŸ" in blocks[0]["text"]["text"]


class TestBlockKitConfig:
    """Test /config modal UI"""

    def test_config_modal_structure(self):
        """Config modal should have all sections"""
        from backend.slack_ui import config_modal

        config_values = {
            "PAVLOK_TYPE_PUNISH": "zap",
            "PAVLOK_VALUE_PUNISH": "50",
            "LIMIT_DAY_PAVLOK_COUNTS": "100",
            "LIMIT_PAVLOK_ZAP_VALUE": "100",
            "IGNORE_INTERVAL": "900",
            "IGNORE_JUDGE_TIME": "3",
            "IGNORE_MAX_RETRY": "5",
            "TIMEOUT_REMIND": "600",
            "TIMEOUT_REVIEW": "600",
            "RETRY_DELAY": "5",
        }

        modal = config_modal(config_values)

        assert modal["type"] == "modal"
        assert modal["callback_id"] == "config_submit"
        assert "âš™ï¸" in modal["title"]["text"]

        # Should have section headers for ç½°, Ignore, Timeout
        headers = [b for b in modal["blocks"] if b.get("type") == "header"]
        assert len(headers) >= 3

        coach_block = next(
            (b for b in modal["blocks"] if b.get("block_id") == "COACH_CHARACTOR"),
            None,
        )
        assert coach_block is not None

    def test_config_modal_punishment_values(self):
        """Punishment config should have correct initial values"""
        from backend.slack_ui import config_modal

        config_values = {
            "PAVLOK_TYPE_PUNISH": "vibe",
            "PAVLOK_VALUE_PUNISH": "70",
        }

        modal = config_modal(config_values)
        blocks = modal["blocks"]

        # Find PAVLOK_TYPE_PUNISH block
        type_block = next(
            (b for b in blocks if b.get("block_id") == "PAVLOK_TYPE_PUNISH"),
            None
        )
        assert type_block is not None
        # Should have initial_option with vibe selected
        element = type_block["element"]
        assert element["action_id"] == "PAVLOK_TYPE_PUNISH_select"

        # Find PAVLOK_VALUE_PUNISH block
        value_block = next(
            (b for b in blocks if b.get("block_id") == "PAVLOK_VALUE_PUNISH"),
            None
        )
        assert value_block is not None
        assert value_block["element"]["initial_value"] == "70"

    def test_config_modal_reset_and_history_buttons(self):
        """Config modal should have reset and history buttons"""
        from backend.slack_ui import config_modal

        modal = config_modal({})

        actions_blocks = [b for b in modal["blocks"] if b.get("type") == "actions"]
        assert len(actions_blocks) >= 1

        actions = actions_blocks[0]["elements"]
        reset_btn = next((e for e in actions if e.get("action_id") == "config_reset_all"), None)
        history_btn = next((e for e in actions if e.get("action_id") == "config_history"), None)

        assert reset_btn is not None
        assert reset_btn["style"] == "danger"
        assert history_btn is not None


class TestBlockKitAudit:
    """Test /audit display UI"""

    def test_audit_log_display(self):
        """Audit log should display recent changes"""
        from backend.slack_ui import audit_log_display

        audit_logs = [
            {
                "changed_at": datetime(2026, 2, 13, 20, 30),
                "config_key": "PAVLOK_VALUE_PUNISH",
                "old_value": "50",
                "new_value": "70",
                "changed_by": "U03JBULT484",
            },
            {
                "changed_at": datetime(2026, 2, 12, 15, 0),
                "config_key": "IGNORE_INTERVAL",
                "old_value": "900",
                "new_value": "600",
                "changed_by": "U03JBULT484",
            },
        ]

        blocks = audit_log_display(audit_logs)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "ðŸ“‹" in blocks[0]["text"]["text"]
        assert "è¨­å®šå¤‰æ›´å±¥æ­´" in blocks[0]["text"]["text"]

        # Should have section blocks for each log
        sections = [b for b in blocks if b.get("type") == "section"]
        assert len(sections) >= len(audit_logs)


class TestBlockKitPlan:
    """Test plan event UI"""

    def test_plan_start_notification(self):
        """Plan start notification should trigger modal"""
        from backend.slack_ui import plan_start_notification

        schedule_id = "123"
        blocks = plan_start_notification(schedule_id)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "ðŸ“…" in blocks[0]["text"]["text"]

        # Should have button to open modal
        actions = [b for b in blocks if b.get("type") == "actions"]
        assert len(actions) >= 1
        button = actions[0]["elements"][0]
        assert button["action_id"] == "plan_open_modal"
        assert schedule_id in button.get("value", "")

    def test_plan_input_modal(self):
        """Plan input modal should have task inputs"""
        from backend.slack_ui import plan_input_modal

        commitments = [
            {"id": "1", "time": "07:00", "task": "æœã®çž‘æƒ³"},
            {"id": "2", "time": "09:00", "task": "ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯"},
        ]

        modal = plan_input_modal(commitments)

        assert modal["type"] == "modal"
        assert modal["callback_id"] == "plan_submit"
        assert "ðŸ“…" in modal["title"]["text"]

        # Should have input blocks for each commitment
        blocks = modal["blocks"]
        task_sections = [b for b in blocks if b.get("type") == "section"]
        # Should have at least the commitments + next_plan section
        assert len(task_sections) >= len(commitments)

    def test_plan_complete_notification(self):
        """Plan complete notification should show scheduled tasks"""
        from backend.slack_ui import plan_complete_notification

        scheduled_tasks = [
            {"task": "æœã®çž‘æƒ³", "time": "07:00", "date": "ä»Šæ—¥"},
            {"task": "ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯", "time": "09:00", "date": "ä»Šæ—¥"},
        ]
        next_plan = {"date": "æ˜Žæ—¥", "time": "07:00"}

        blocks = plan_complete_notification(scheduled_tasks, next_plan)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "ç™»éŒ²ã—ã¾ã—ãŸ" in blocks[0]["text"]["text"]

        # Should have section with task list
        sections = [b for b in blocks if b.get("type") == "section"]
        assert len(sections) >= 1


class TestBlockKitRemind:
    """Test remind event UI"""

    def test_remind_post_blocks(self):
        """Remind post should have YES/NO buttons"""
        from backend.slack_ui import remind_post

        schedule_id = "123"
        task_name = "æœã®çž‘æƒ³"
        task_time = "07:00"
        description = "é™ã‹ãªå ´æ‰€ã§5åˆ†é–“ã€å‘¼å¸ã«é›†ä¸­ã—ã¾ã—ã‚‡ã†ã€‚\næº–å‚™ã¯ã§ãã¾ã—ãŸã‹ï¼Ÿ"

        blocks = remind_post(schedule_id, task_name, task_time, description)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "ðŸ””" in blocks[0]["text"]["text"]

        # Should have YES/NO buttons
        actions = [b for b in blocks if b.get("type") == "actions"]
        assert len(actions) >= 1
        buttons = actions[0]["elements"]
        assert len(buttons) == 2

        yes_btn = next((b for b in buttons if b.get("action_id") == "remind_yes"), None)
        no_btn = next((b for b in buttons if b.get("action_id") == "remind_no"), None)

        assert yes_btn is not None
        assert yes_btn["style"] == "primary"
        assert no_btn is not None
        assert no_btn["style"] == "danger"
        assert schedule_id in yes_btn.get("value", "")
        assert schedule_id in no_btn.get("value", "")

    def test_remind_yes_response(self):
        """YES response should show completion"""
        from backend.slack_ui import remind_yes_response

        task_name = "æœã®çž‘æƒ³"
        comment = "è‰¯ã„ä¸€æ—¥ã®ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ï¼"

        blocks = remind_yes_response(task_name, comment)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "section"
        assert "âœ“" in blocks[0]["text"]["text"]
        assert task_name in blocks[0]["text"]["text"]

    def test_remind_no_response(self):
        """NO response should show punishment"""
        from backend.slack_ui import remind_no_response

        task_name = "æœã®çž‘æƒ³"
        no_count = 2
        punishment = {"type": "zap", "value": 45}
        comment = "æ˜Žæ—¥ã“ãã¯ã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚"

        blocks = remind_no_response(task_name, no_count, punishment, comment)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "section"
        assert "âœ•" in blocks[0]["text"]["text"]
        assert task_name in blocks[0]["text"]["text"]
        assert str(no_count) in blocks[0]["text"]["text"]


class TestBlockKitIgnore:
    """Test ignore detection UI"""

    def test_ignore_detection_post(self):
        """Ignore detection post should have YES/NO buttons"""
        from backend.slack_ui import ignore_detection_post

        schedule_id = "123"
        task_name = "æœã®çž‘æƒ³"
        task_time = "07:00"
        ignore_minutes = 15
        punishment = {"type": "vibe", "value": 100}

        blocks = ignore_detection_post(schedule_id, task_name, task_time, ignore_minutes, punishment)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "âš ï¸" in blocks[0]["text"]["text"] or "å¿œç­”å¾…ã¡" in blocks[0]["text"]["text"]

        # Should have YES/NO buttons
        actions = [b for b in blocks if b.get("type") == "actions"]
        assert len(actions) >= 1
        buttons = actions[0]["elements"]

        yes_btn = next((b for b in buttons if b.get("action_id") == "ignore_yes"), None)
        no_btn = next((b for b in buttons if b.get("action_id") == "ignore_no"), None)

        assert yes_btn is not None
        assert no_btn is not None

    def test_ignore_max_reached_post(self):
        """Max ignore reached should show cancellation"""
        from backend.slack_ui import ignore_max_reached_post

        task_name = "æœã®çž‘æƒ³"
        task_time = "07:00"
        final_punishment = {"type": "zap", "value": 100}

        blocks = ignore_max_reached_post(task_name, task_time, final_punishment)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "âŒ" in blocks[0]["text"]["text"] or "ã‚­ãƒ£ãƒ³ã‚»ãƒ«" in blocks[0]["text"]["text"]


class TestBlockKitError:
    """Test error notification UI"""

    def test_error_notification(self):
        """Error notification should show error message"""
        from backend.slack_ui import error_notification

        error_message = "ValueError: ç½°å¼·åº¦ã¯0-100ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„"
        retry_action_id = "retry_config"

        blocks = error_notification(error_message, retry_action_id)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        assert "âŒ" in blocks[0]["text"]["text"] or "ã‚¨ãƒ©ãƒ¼" in blocks[0]["text"]["text"]

        # Should have retry button
        actions = [b for b in blocks if b.get("type") == "actions"]
        assert len(actions) >= 1
        retry_btn = actions[0]["elements"][0]
        assert retry_btn.get("action_id") == retry_action_id

    def test_daily_zap_limit_notification(self):
        """Daily ZAP limit notification should show warning"""
        from backend.slack_ui import daily_zap_limit_notification

        limit = 100

        blocks = daily_zap_limit_notification(limit)

        assert isinstance(blocks, list)
        assert blocks[0]["type"] == "header"
        # The limit value should appear somewhere in the blocks (might be in different block)
        all_text = str(blocks)
        assert str(limit) in all_text


class TestBlockKitHelpers:
    """Test helper functions"""

    def test_format_timestamp_jst(self):
        """Should format datetime to JST string"""
        from backend.slack_ui import format_timestamp_jst

        dt = datetime(2026, 2, 14, 7, 30)
        formatted = format_timestamp_jst(dt)

        assert "2026-02-14" in formatted
        assert "07:30" in formatted

    def test_punishment_display_text(self):
        """Should format punishment for display"""
        from backend.slack_ui import punishment_display_text

        punishment = {"type": "zap", "value": 50}
        text = punishment_display_text(punishment)

        assert "zap" in text.lower() or "âš¡" in text
        assert "50" in text or "50%" in text
